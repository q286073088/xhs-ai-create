# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

这是一个基于 Next.js 14 构建的小红书爆款文案生成器，使用 AI 分析热门笔记并生成高质量的小红书内容。项目采用前后端一体化架构，使用 TypeScript 和 Tailwind CSS。

**最新版本 v2.2**：深度借鉴技术文档降 AIGC 策略，目标检测率 <10%。在 v2.1 基础上新增动词短语扩展、口语化辅助词注入、条件句式转换、介词系统性替换和字数精准控制，形成 11 大策略体系。

## 核心架构

### AI 双重专家系统

项目的核心是两阶段 AI 处理流程，通过精心设计的提示词实现：

1. **分析阶段** (`lib/prompts.ts::getAnalysisPrompt`)
   - 分析热门笔记的标题公式、内容结构、标签策略和封面风格
   - 提取可套用的爆款模式
   - 返回严格的 JSON 格式分析报告

2. **创作阶段** (`lib/prompts.ts::getGenerationPrompt`) - **v2.2 深度升级**
   - 基于分析结果和用户素材生成内容
   - **【v2.2 新增】11 大降低 AIGC 率核心策略**：
     - **动词短语扩展**（v2.2 新增）：将简洁动词扩展为短语（"用"→"开始用"/"去用"）
     - **口语化辅助词注入**（v2.2 新增）：增加句子饱满度（"真的"、"居然"、"算是"等）
     - **条件句式转换**（v2.2 新增）：书面语转口语（"若...则..."→"要是...那就..."）
     - **介词系统性替换**（v2.2 强化）：避免固定用词（"通过"→"借助/依靠/凭借"）
     - **字数精准控制**（v2.2 新增）：450-750字，强调不啰嗦、保持信息密度
     - 词汇多样性（v2.1）：系统性替换库，避免重复使用相同表达
     - 句式随机化（v2.1）：混合疑问句、感叹句、倒装句、省略句
     - 自然不完美特征（v2.1）：停顿、修正、重复强调
     - 情绪波动轨迹（v2.1）：犹豫→确认、期待→失落→惊喜
     - 思维跳跃与偏题（v2.1）："对了差点忘了说"
     - 细节随机性（v2.1）："4天"而非"一周"、"89块"而非"90元"
     - 反结构化（v2.1）：段落长度不规则、emoji 随机、开头多样化
   - 注重"去 AI 味"：避免使用模板化表达（首先、其次等）
   - 强调生活化细节和真实感

### 多模型降级机制

AI 管理器 (`lib/ai-manager.ts`) 支持智能模型切换：
- 从 `AI_MODEL_NAME` 环境变量读取逗号分隔的模型列表
- 按顺序尝试每个模型，每个模型有独立的重试次数（默认 2 次）
- 使用指数退避策略处理临时故障（初始 1 秒，最大 8 秒）
- 特别处理 Gemini 模型（不使用 `response_format: json_object`，避免 choices 为空错误）

**降级流程示例**（配置：`gemini-2.5-pro,gemini-2.5-flash`）：
1. 尝试 `gemini-2.5-pro`（重试 2 次，间隔 1s、2s）
2. 失败后切换到 `gemini-2.5-flash`（重试 2 次）
3. 所有模型失败后抛出错误
4. 下次请求重新从第一个模型开始

**错误处理**：
- 网络错误：自动重试
- API 配额错误：立即切换下一个模型
- JSON 解析错误：记录日志并重试

### 三重安全保障

1. **格式稳定性** (`app/api/generate-combined/route.ts`)
   - 后端内容清洗：过滤 AI 前置解释文字
   - 检测 `## 1.` 标记后才开始输出内容

2. **内容安全性** (`lib/sensitive-words.ts`)
   - 105+ 敏感词库实时过滤
   - 智能替换策略（"最" → "很"）

3. **验证完整性** (`lib/ai-manager.ts`)
   - `validateJsonResponse`: 验证 JSON 结构
   - 针对 `titleFormulas`, `contentStructure`, `tagStrategy`, `coverStyleAnalysis` 的专项验证

### 缓存系统

智能三层降级策略 (`lib/cache-manager.ts`)：
1. **优先使用有效缓存**（默认 24 小时，可配置）
   - 检查 `data/cache/{keyword}.json` 是否存在且未过期
   - 缓存文件包含 `processedNotes` 和 `timestamp`
   - ⚠️ 注意：如果 `ENABLE_SCRAPING=false`，将跳过所有缓存读取
2. **实时抓取小红书数据**（可通过环境变量禁用）
   - 使用 `XHS_COOKIE` 调用小红书搜索 API
   - 抓取成功后自动保存到缓存
   - 可通过 `ENABLE_SCRAPING=false` 完全禁用爬取功能
3. **降级到同分类备用缓存**
   - 如果抓取失败，查找最近的备用缓存文件
   - 使用其他关键词的缓存数据作为应急方案
   - ⚠️ 注意：如果 `ENABLE_SCRAPING=false`，将跳过备用缓存

**配置选项**：
- `ENABLE_CACHE=true/false`: 启用/禁用缓存功能（仅当 `ENABLE_SCRAPING=true` 时生效）
- `ENABLE_SCRAPING=true/false`: 启用/禁用小红书爬取功能
  - `true`（推荐）: 使用完整的三层降级策略（缓存 → 爬取 → 备用缓存）
  - `false`: 完全跳过数据获取，不读取任何缓存，直接基于用户素材创作
- `CACHE_CONFIG.expiryHours`: 缓存过期时间（默认 24 小时）
- `CACHE_CONFIG.maxFallbackAge`: 备用缓存最大年龄（默认 7 天）
- 缓存文件存储在 `data/cache/` 目录（需要写权限）

**使用场景**：
- **`ENABLE_SCRAPING=true`**（默认）：
  - 适用于：生产环境、需要基于真实热门数据生成内容
  - 优势：生成的内容更贴合当前爆款趋势
- **`ENABLE_SCRAPING=false`**：
  - 适用于：测试环境、不想调用小红书 API、仅依赖 AI 知识创作
  - 优势：不依赖外部数据，响应更快，无 Cookie 失效问题
  - 注意：生成的内容完全基于 AI 对爆款内容的理解，可能不如有参考数据的效果好

## 开发命令

```bash
# 安装依赖
npm install

# 开发服务器（端口 3000）
npm run dev

# 生产构建
npm run build

# 启动生产服务器
npm start

# 代码检查（ESLint）
npm run lint
```

**注意**：当前项目没有配置测试脚本。如需添加测试，建议使用 Jest + React Testing Library。

## 测试工具

项目包含一些调试和测试工具：

- **`public/test-count.html`** - 测试小红书数据获取数量的调试工具
- **`public/test-flow.html`** - API接口测试页面，用于调试分析接口和生成接口
- **`test-optimization.md`** - 优化测试文档，记录了v2.2版本的优化内容和测试计划

## 环境变量配置

必需配置（复制 `.env.example` 为 `.env.local`）：

```bash
# AI 服务配置（必填）
THIRD_PARTY_API_URL="https://your-api-provider.com/v1"
THIRD_PARTY_API_KEY="your_api_key_here"
AI_MODEL_NAME="gemini-2.5-pro,gemini-2.5-flash"  # 支持多模型降级

# 小红书数据抓取（必填，用于真实数据）
XHS_COOKIE="your_xiaohongshu_cookie_here"

# 可选配置
ENABLE_CACHE=true  # 缓存开关
ENABLE_SCRAPING=true  # 爬取开关（新增）
ENABLE_DEBUG_LOGGING=true  # 调试日志
PRODUCTION_URL="https://your-domain.vercel.app"  # 生产环境 CORS
```

**新增环境变量说明**：
- `ENABLE_SCRAPING`: 控制小红书爬取功能
  - `true`（默认）: 启用完整的数据获取流程（缓存 → 爬取 → 备用缓存）
  - `false`: 完全禁用数据获取（不使用缓存），直接基于用户素材和 AI 知识创作
  - 适用场景：
    - 设置为 `false`: 测试环境、Cookie 失效、不想依赖外部数据
    - 设置为 `true`: 生产环境、需要基于热门趋势生成更精准的内容

## 项目结构

```
app/
├── api/
│   ├── analyze-hot-posts/    # ⚠️ 已废弃：独立热门分析 API
│   ├── generate-combined/    # ✅ 主 API：组合分析+生成流程（生产环境使用）
│   └── cron/clean-cache/     # 定时清理缓存
├── globals.css               # 全局样式（含自定义动画）
├── layout.tsx                # 根布局（含 metadata）
└── page.tsx                  # 主页面（服务端渲染）

components/
├── GeneratorClient.tsx       # 核心客户端组件（表单+流式输出+状态管理）
├── AuthorCard.tsx            # 作者信息卡片
├── FaqSection.tsx            # FAQ 常见问题
├── StructuredData.tsx        # SEO 结构化数据
└── ui/                       # Shadcn/ui 组件库

lib/
├── prompts.ts                # 提示词管理（核心，v2.2 版本）
├── ai-manager.ts             # AI 交互管理（重试+验证+模型降级）
├── cache-manager.ts          # 缓存管理（三层降级策略）
├── sensitive-words.ts        # 敏感词过滤（105+ 词库）
├── error-handler.ts          # 错误处理（BusinessError）
├── constants.ts              # 常量定义（API端点、配置）
├── types.ts                  # TypeScript 类型定义
└── utils.ts                  # 工具函数
```

## 关键技术要点

### 完整请求生命周期

**用户提交表单 → 生成内容的完整数据流**：

1. **客户端发起请求** (`components/GeneratorClient.tsx`)
   - 用户填写关键词和素材信息
   - 调用 `fetch('/api/generate-combined', { method: 'POST' })`
   - 监听 ReadableStream 流式响应

2. **服务端处理** (`app/api/generate-combined/route.ts`)
   - 验证输入参数（关键词、用户信息）
   - 调用 `fetchHotPostsWithCache(keyword)` 获取热门笔记数据
   - 使用 AI 分析专家生成分析报告（JSON 格式）
   - 使用 AI 创作专家基于分析结果生成内容（流式输出）
   - 每个 chunk 经过敏感词过滤后发送到客户端

3. **客户端实时渲染**
   - 使用 `useEffect` 监听 `generatedContent` 变化
   - 正则表达式解析出 4 个部分：标题、正文、标签、AI 绘画提示
   - 打字机效果逐字显示内容
   - 独立复制按钮支持单独复制每个部分

### 流式生成处理

`app/api/generate-combined/route.ts` 使用 SSE (Server-Sent Events)：
- 创建 `ReadableStream` 返回流式响应
- 使用 `aiManager.generateStreamWithRetry` 处理 AI 流式输出
- 自动清洗前置内容，只输出从 `## 1.` 开始的正文
- 每个 chunk 实时进行敏感词过滤

**工作流程**：
1. 通过 `fetchHotPostsWithCache` 获取小红书热门数据（三层降级：缓存 → 爬取 → 备用缓存）
2. 调用 `aiManager.generateAnalysisWithRetry` 分析热门笔记（JSON 格式）
3. 基于分析结果调用 `aiManager.generateStreamWithRetry` 流式生成内容
4. 使用 `TextEncoder` 将数据流式传输到客户端
5. 客户端 `GeneratorClient.tsx` 实时解析并显示（打字机效果）

### JSON 响应验证

AI 返回的 JSON 必须包含以下字段（`lib/ai-manager.ts::validateJsonResponse`）：
- `titleFormulas`: 标题公式分析
- `contentStructure`: 内容结构（开头钩子、正文模板、结尾钩子）
- `tagStrategy`: 标签策略（commonTags 字段会自动从 tagCategories 提取）
- `coverStyleAnalysis`: 封面风格分析

**重要**：Gemini 模型对 `response_format: json_object` 支持有限，代码会自动检测并跳过该设置。

### 客户端状态管理

`components/GeneratorClient.tsx` 使用 React Hooks 管理状态：
- `formData`: 表单数据（keyword, userInfo）
- `generatedContent`: 完整生成内容
- `displayedContent`: 打字机效果的显示内容
- `isGenerating`: 生成中状态
- 实时解析流式内容为 4 个部分：标题、正文、标签、AI 绘画提示词

### 敏感词处理

`lib/sensitive-words.ts` 提供两种模式：
- `replace`: 智能替换（默认，生产环境）
- `highlight`: 高亮显示（开发调试用）

支持 8 大类敏感词：绝对化用语、医疗用语、夸大宣传等。

## 降低 AIGC 检测率核心策略（v2.2）

### 设计理念

v2.2 版本深度借鉴技术文档降 AIGC 提示词策略，目标是将 AIGC 检测率降低到 <10%（v2.1 目标为 <30%）。通过系统性地引入人类写作的特征和"不完美性"，让 AI 生成的内容更加自然：

1. **动词短语扩展**（v2.2 新增）- 打破 AI 的简洁化倾向
2. **口语化辅助词注入**（v2.2 新增）- 增加人类写作的"冗余"特征
3. **条件句式转换**（v2.2 新增）- 书面语 → 口语化
4. **介词系统化替换**（v2.2 强化）- 避免固定用词模式
5. **字数精准控制**（v2.2 新增）- 保持信息密度，不啰嗦
6. **词汇多样性**（v2.1）- 避免 AI 的重复模式
7. **句式随机性**（v2.1）- 打破可预测的结构
8. **自然不完美**（v2.1）- 模拟真人写作的"瑕疵"
9. **情绪波动**（v2.1）- 展现真实的心理变化
10. **思维跳跃**（v2.1）- 模拟自然思维流
11. **反结构化**（v2.1）- 消除机械感

### 核心组件（`lib/prompts.ts`）

#### 1. 词汇替换库 (`WORD_VARIATIONS`) - v2.2 强化

系统性地定义同一概念的多种表达方式，v2.2 版本新增动词短语扩展和介词替换：

```typescript
const WORD_VARIATIONS = {
  // 动词类 - 短语扩展策略（v2.2 新增）
  "用": ["开始用", "去用", "试着用", "用起来", "用上了"],
  "买": ["入手了", "拿下了", "剁手买了", "下单买了", "买到手"],
  "做": ["去做", "开始做", "做起来", "着手做"],

  // 介词类 - 系统性替换（v2.2 新增）
  "通过": ["借助", "依靠", "凭借", "靠着", "用"],
  "对于": ["关于", "说到", "提到", "讲到"],

  // 动词 - 带过程描述的扩展（v2.1）
  "使用": ["用", "试试", "上手", "整上", "搞个", "弄个"],
  "推荐": ["安利", "墙裂推荐", "真的建议", "可以试试", "值得入手"],
  // ... 更多替换项（共 80+ 项）
};
```

**使用方式**：
- AI 在提示词中会看到这个库，并被要求在全文中使用不同表达
- v2.2 重点：动词要扩展为短语，介词要系统性替换
- 示例："用这个产品" → "开始用这个产品" / "去用这个产品"

#### 2. 口语化辅助词库 (`COLLOQUIAL_FILLERS`) - v2.2 新增

增加句子饱满度，模拟人类口语的"冗余"特征：

```typescript
const COLLOQUIAL_FILLERS = {
  确认词: ["真的", "确实", "的确", "实在", "说实话", "老实说"],
  惊讶词: ["居然", "竟然", "简直", "没想到", "意外地"],
  评估词: ["算是", "应该", "大概", "差不多", "基本上", "几乎"],
  转折词: ["其实", "反而", "倒是", "反正", "至少"],
  状态词: ["已经", "还", "也", "又", "就", "才", "都"],
};
```

**效果示例**：
- ❌ "效果好" → ✅ "效果真的好" / "效果居然这么好" / "效果算是不错"
- ❌ "我喜欢" → ✅ "我还挺喜欢" / "我确实喜欢" / "我简直爱了"

#### 3. 条件句式转换模板 (`CONDITIONAL_PATTERNS`) - v2.2 新增

将书面化的条件句转换为口语化表达：

```typescript
const CONDITIONAL_PATTERNS = [
  "若...则... → 要是...那就...",
  "如果...便... → 假如...就...",
  "倘若...即... → 万一...就...",
  "由于...因此... → 因为...所以...",
  "鉴于...故... → 既然...那...",
  "虽然...但是... → 尽管...不过...",
];
```

**效果示例**：
- ❌ "若价格合适，则可以购买" → ✅ "要是价格合适，那就可以买"

#### 4. 句式起始词库 (`SENTENCE_STARTERS`) - v2.1

提供多样化的句子开头，避免固定模式：

```typescript
const SENTENCE_STARTERS = [
  "说实话", "不得不说", "讲真", "老实讲", "怎么说呢",
  "你别说", "我发现", "有件事", "关于这个", "提到这个",
  // ...
];
```

#### 5. 情绪转折词库 (`EMOTIONAL_TRANSITIONS`) - v2.1

模拟真实的心理变化轨迹：

```typescript
const EMOTIONAL_TRANSITIONS = [
  "本来还担心...结果发现完全多虑了",  // 犹豫 → 确认
  "以为会很好...用了后觉得一般...但坚持几天后...哇塞",  // 期待 → 失落 → 惊喜
  "刚开始我是拒绝的...但架不住朋友一直夸...试了后...真香",  // 质疑 → 认可
];
```

#### 6. 不完美表达库 (`IMPERFECT_EXPRESSIONS`) - v2.1

允许的"不完美"表达，模拟真人写作的停顿和犹豫：

```typescript
const IMPERFECT_EXPRESSIONS = [
  "就是...那种感觉",
  "怎么说呢...就是很舒服",
  "好像是...应该没错",
  "差不多就是这样",
  "效果嘛...你们懂的",
];
```

### 提示词策略

在 `getGenerationPrompt` 中，v2.2 版本整合了 v2.1 的基础上新增 5 大策略，形成完整的反 AIGC 检测指令体系：

#### 动词短语扩展（v2.2 新增）

```
- 将简洁动词扩展为带过程描述的短语，增加自然度
- 示例："用" → "开始用"、"去用"、"试着用"、"用起来"
- 示例："买" → "入手了"、"拿下了"、"剁手买了"
- 禁止总是使用最简洁的动词，要适当扩展
```

#### 口语化辅助词注入（v2.2 新增）

```
- 适当增加口语化辅助词，使句子更生动自然
- 确认/强调："真的"、"确实"、"的确"、"实在"
- 意外/惊讶："居然"、"竟然"、"简直"、"没想到"
- 程度/评估："算是"、"应该"、"大概"、"差不多"
- 转折/补充："其实"、"反而"、"倒是"、"反正"
- 示例："效果好" → "效果真的好" / "效果居然这么好"
```

#### 条件句式转换（v2.2 新增）

```
- 将书面化的条件句转换为口语化表达
- 示例：
  * ❌ "若价格合适，则可以购买"
  * ✅ "要是价格合适，那就可以买"
  * ❌ "如果效果好，便值得推荐"
  * ✅ "假如效果好，就值得推荐"
```

#### 介词系统性替换（v2.2 强化）

```
- 同一介词在全文中必须使用不同表达
- "通过"→"借助/依靠/凭借"，"对于"→"关于/说到/提到"
- 示例："通过这个方法"→"借助这个方法"→"依靠这个方法"
```

#### 字数精准控制（v2.2 新增）

```
- 正文字数严格控制在 450-750 字之间
- **重要**：不要为了凑字数而啰嗦，保持信息密度
- 避免无意义的重复和过度扩展
- 每句话都要有实际信息量，不要空洞的感叹
- 如果素材信息不足以支撑 600 字，宁可精简到 500 字，也不要注水
```

#### 词汇多样性要求（v2.1）

```
- 同一概念在全文中必须使用不同表达，严格禁止重复
- 参考词汇替换库：[完整库内容]
- 示例："很好"在文中第1次用"不错"，第2次用"可以"，第3次用"还挺棒"
```

#### 句式随机化要求

```
- 句式类型必须混合：陈述句、疑问句、感叹句、祈使句
- 禁止连续使用相同句式结构
- 使用"把"字句、倒装句、省略句
- 参考句式起始词：[完整列表]
```

#### 自然不完美性要求

```
- 允许口语化停顿："就是...那种感觉"
- 允许自我修正："一开始觉得贵，但后来发现...其实还好"
- 允许重复强调："真的真的很推荐"
- 允许犹豫表达："好像是"、"应该算是"
```

#### 细节随机性要求（关键！）

```
- 时间不要用"一周"、"一个月"，改用"4天"、"5天左右"、"大概10来天"
- 价格不要整数，用"89块"、"大概200出头"、"不到150"
- 用量描述具体："黄豆大小"、"一元硬币那么多"
```

#### 反结构化策略

```
- 开头多样化：不要每次都是"姐妹们"开头
- 段落长度随机：有的段落1行，有的段落7-8行
- Emoji 使用随机：不要固定每段1-2个
```

### 自检清单

v2.2 版本自检清单共 **16 项检查**（v2.1 基础 10 项 + v2.2 新增 6 项），AI 在生成内容前会进行自我检查：

**基础检查（v2.1，10 项）：**
```
- [ ] 词汇多样性：同一概念是否使用了至少3种不同表达？
- [ ] 句式随机性：是否混合使用了疑问句、感叹句、倒装句、省略句？
- [ ] 不完美特征：是否包含停顿、修正、重复？
- [ ] 情绪转折：是否有至少1个情绪波动？
- [ ] 思维跳跃：是否有偶尔偏题或突发想法的表达？
- [ ] 细节随机性：时间是否避免了整数？价格是否避免了整数？
- [ ] 结构不规则：段落长度是否有变化？
- [ ] Emoji 随机性：是否避免了每段固定1-2个的模式？
- [ ] 开头多样化：是否避免了固定的开头？
- [ ] 黑名单规避：是否完全避免了"首先、其次、总之"等词？
```

**新增检查（v2.2，6 项）：**
```
- [ ] 动词扩展：是否将简洁动词扩展为短语？（"用"→"开始用"/"去用"）
- [ ] 辅助词注入：是否适当使用了口语化辅助词？（"真的"、"居然"、"算是"）
- [ ] 条件句式转换：是否将书面化条件句转换为口语？（"若...则..."→"要是...那就..."）
- [ ] 介词替换：是否对介词进行了多样化替换？（"通过"→"借助"/"依靠"）
- [ ] 字数精准：是否避免了为凑字数而啰嗦？每句话是否都有实际信息量？
- [ ] 句子饱满度：是否通过辅助词使句子更自然饱满？
```

### 监控指标

建议在生产环境监控以下指标：

**必须监控（每日）：**
- **AIGC 检测率**（目标：< 10%，v2.1 目标为 < 30%）
- **词汇重复率**（同一词汇在文中重复频率 < 5%）
- **辅助词使用率**（v2.2 新增，每 100 字至少 8-12 个辅助词）
- **动词扩展率**（v2.2 新增，简洁动词被扩展的比例 > 60%）

**可选监控（每周）：**
- 句式多样性评分
- 用户反馈的内容自然度评分
- 介词替换多样性（v2.2 新增）

## 常见开发任务

### 修改 AI 提示词

编辑 `lib/prompts.ts`：
- `getAnalysisPrompt`: 修改分析逻辑
- `getGenerationPrompt`: 修改创作策略
- 注意保持 JSON 输出格式的严格性

**v2.2 策略调整**：
- 修改词汇替换库 `WORD_VARIATIONS`：添加更多动词短语扩展和介词替换
- 修改口语化辅助词库 `COLLOQUIAL_FILLERS`：增加新的辅助词（5 类）
- 修改条件句式转换模板 `CONDITIONAL_PATTERNS`：添加更多转换模式
- 修改句式起始词库 `SENTENCE_STARTERS`：增加新的开头方式（v2.1）
- 修改情绪转折词库 `EMOTIONAL_TRANSITIONS`：添加更多情绪轨迹（v2.1）
- 修改不完美表达库 `IMPERFECT_EXPRESSIONS`：增加口语化表达（v2.1）

**维护建议**：
- **每两周**：轮换口语化辅助词池和词汇替换库
- **每月**：分析 AIGC 检测失败案例，优化策略
- **每季度**：评估整体效果，调整参数

### 添加新的验证字段

1. 在 `lib/prompts.ts` 中定义新的 JSON 字段
2. 在 `lib/ai-manager.ts` 中添加对应的验证函数（如 `validateXXX`）
3. 将字段名添加到 `expectedFields` 数组

### 调整模型配置

修改 `.env.local` 中的 `AI_MODEL_NAME`：
```bash
# 单模型
AI_MODEL_NAME="gemini-2.5-pro"

# 多模型降级（推荐）
AI_MODEL_NAME="gemini-2.5-pro,gemini-2.5-flash,gpt-4o-mini"
```

### 调试 AI 响应问题

1. 设置 `ENABLE_DEBUG_LOGGING=true`
2. 查看控制台输出的详细日志：
   - `🔍 AI响应前100字符`
   - `✅ JSON解析成功，包含字段`
   - `⚠️ 模型X尝试Y失败`

### 修改缓存策略

编辑 `lib/cache-manager.ts` 中的 `CACHE_CONFIG`：
```typescript
const CACHE_CONFIG = {
  expiryHours: 24,  // 修改过期时间
  cacheDir: './data/cache',
  maxFallbackAge: 7 * 24  // 备用缓存最大年龄
};
```

## 部署注意事项

### Vercel 部署

1. 确保在 Vercel 项目设置中配置所有环境变量
2. **重要**：`data/cache/` 目录在 Vercel 中是临时的，每次部署会清空
   - Vercel 使用无服务器函数，不支持持久化文件系统
   - 建议使用外部存储（如 Vercel KV、Redis）或接受缓存在每次部署后失效
3. 可选：配置 Vercel Cron Jobs 调用 `/api/cron/clean-cache`
4. **调整超时时间**：如果生成时间较长，在 `vercel.json` 中设置 `maxDuration`

### 本地生产环境测试

```bash
# 构建生产版本
npm run build

# 启动生产服务器
npm start

# 访问 http://localhost:3000 测试
```

### 性能优化

- 缓存功能在生产环境强烈推荐开启（减少 API 调用）
- 如果 API 调用频繁失败，检查模型降级配置
- 调整 `CONFIG.REQUEST_TIMEOUT`（默认 15 秒）以适应网络环境
- 使用 `ENABLE_DEBUG_LOGGING=false` 减少日志输出（生产环境）

### 监控建议

生产环境建议监控以下指标：
- API 请求成功率和响应时间
- 模型降级触发频率
- 缓存命中率（有效缓存 vs 备用缓存 vs 实时抓取）
- 敏感词过滤触发次数
- AIGC 检测率（目标 < 10%）

## 常见问题排查

### AI 响应 choices 为空

**原因**：某些模型对 JSON 格式支持有限
**解决**：代码已自动处理 Gemini 模型，跳过 `response_format`。如使用其他模型遇到问题，可在 `lib/ai-manager.ts` 中调整逻辑。

### 小红书数据抓取失败

**原因**：Cookie 过期或 IP 被限制
**解决**：
1. 更新 `XHS_COOKIE` 环境变量
2. 启用缓存功能会自动降级到备用数据

### 生成内容包含多余前置文字

**原因**：AI 在 `## 1.` 前输出了解释性文字
**解决**：后端已自动过滤，确保 `app/api/generate-combined/route.ts::startMarker` 设置正确。

### TypeScript 类型错误

项目使用严格模式 (`strict: true`)，确保：
- 所有 API 响应都有对应的类型定义（`lib/types.ts`）
- 环境变量通过 `getEnvVar` 函数访问（提供类型安全）

## 代码风格约定

- 使用 TypeScript 严格模式
- 组件使用函数式 + Hooks 模式
- API 路由使用 Next.js 14 App Router 约定
- 错误处理统一使用 `BusinessError` 类
- 日志输出使用表情符号前缀增强可读性（🔍 🚨 ✅ ⚠️）

# 不要运行命令测试，由人来测试。